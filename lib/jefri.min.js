var Request;Request=function(){var a,b;return a=function(a){var b,c,d;return c=Q.defer(),b=window.ActiveXObject||XMLHttpRequest,d=new b("Microsoft.XMLHTTP"),d.open(a.type||(a.data?"POST":"GET"),a.uri,!0),"function"==typeof d.overrideMimeType&&d.overrideMimeType(a.dataType||"text/plain"),d.onreadystatechange=function(){var b;return 4===d.readyState?(0===d.status||200===d.status?(b=d.responseText,"application/json"===a.dataType&&(b=JSON.parse(b)),c.resolve(b)):c.reject(new Error("Could not load "+a.uri)),void 0):c.notify(d)},a.data&&d.setRequestHeader("Content-type",a.dataType||"application/x-www-form-urlencoded"),d.send(a.data||null),c.promise},b=function(a,c){return c?b.post(a,{data:c}):b.get(a)},b.get=function(b,c){return c=c||{},c.uri=b,c.type="GET",c.data=null,a(c)},b.post=function(b,c){return c=c||{},c.uri=b,c.type="POST",a(c)},b}(),function(a,b,c){var d;d=function(){},d.prototype={on:function(a,b){var c;return void 0===this._listeners&&(this._listeners={}),c=this._listeners,void 0===c[a]&&(c[a]=[]),-1===c[a].indexOf(b)?c[a].push(b):void 0},off:function(a,b){var c,d;if(void 0!==this._listeners)return d=this._listeners,c=d[a].indexOf(b),-1!==c?d[a].splice(c,1):void 0},trigger:function(a){var b,c,d,e,f,g;if(void 0!==this._listeners&&(d=this._listeners,c=d[a.event],void 0!==c)){for(a.target=this,g=[],e=0,f=c.length;f>e;e++)b=c[e],g.push(b.call(this,a));return g}}};var e,f,g=[].slice;e={EntityComparator:function(a,b){var c;return c=a&&b&&a._type()===b._type()&&a.id()===b.id()},isEntity:function(b){return b._type&&b.id&&a.isFunction(b._type)&&a.isFunction(b.id)}},a.mixin({isEntity:e.isEntity}),e.Runtime=function(b,f,h){var i,j,k,l,m,n,o,p,q,r,s=this;return!this instanceof e.Runtime?new e.Rutime(b,f,h):(i=this,a.isString(b)||(h=f,f=b,b=""),j=Q.defer(),k={updateOnIntern:!0},a(k).extend(f),a(this).extend({settings:k,ready:j.promise,_context:{meta:{},contexts:{},entities:{},attributes:{}},_instances:{}}),q=function(a){switch(a){case"boolean":return!1;case"int":return 0;case"string":return"";default:return""}},r=function(b){var c,d,e,f;a(s._context.attributes).extend(b.attributes||{}),e=b.entities,f=[];for(d in e)c=e[d],f.push(l(c,d));return f},l=function(b,c){return s._context.entities[c]=b,s._instances[c]={},b.Constructor=function(c){var d,e,f,g;a(this).extend({_new:!0,_modified:{_count:0},_fields:{},_relationships:{},_runtime:i}),c=c||{},c[b.key]=c[b.key]||a.UUID.v4(),g=b.properties;for(e in g)f=g[e],d=c[e]||q(f.type),this[e](d);return this._id=this.id(!0),a(this.prototype).extend(c.prototype),this.on("persisted",function(){return a(this).extend({_new:!1,_modified:{_count:0}})}),this},o(c,b,h&&h[c])},o=function(b,c,f){var g,h,j,k,l,o,q,r,s;a(c.Constructor.prototype).extend(d.prototype,{_type:function(a){return a=a||!1,b},id:function(a){return""+(a?""+this._type()+"/":"")+this[c.key]()},_status:function(){var b;return b="MODIFIED",this._new?b="NEW":a.isEmpty(this._modified)&&(b="PERSISTED"),b},_definition:function(){return c},_persist:function(b,c){var d,f;return d=a.Deferred().then(c),f=!b,b=f?new e.Transaction:b,b.add(this),this.on("persisting",b),f&&b.persist(c),d.promise()},_encode:function(){var a,b;a={_type:this._type(),_id:this.id()};for(b in c.properties)a[b]=this[b]();return a},_destroy:a.lock(function(){var a,b;this.trigger("destroying",{});for(a in c.relationships)null!=(b=this[a])&&b.remove.call(this);return i.destroy(this),this[c.key](0),this.trigger("destroyed",{})}),_compare:function(a){return e.EntityComparator(this,a)}}),c.Constructor.prototype.toJSON=c.Constructor.prototype._encode,q=c.properties;for(g in q)k=q[g],n(c,g,k);r=c.relationships;for(l in r)o=r[l],p(c,l,o);s=c.methods;for(j in s)h=s[j],m(c,j,h);return f?a(c.Constructor.prototype).extend(f.prototype):void 0},n=function(b,c){return b.Constructor.prototype[c]=function(a){return arguments.length>0?this[c].set.call(this,a):this[c].get.call(this)},a(b.Constructor.prototype[c]).extend({set:function(a){return a!==this._fields[c]?(this._fields[c]=a,this._modified[c]?this._modified[c]===a&&(delete this._modified[c],this._modified._count-=1):(this._modified[c]=this._fields[c],this._modified._count+=1),this.trigger("modified",[c,a])):void 0},get:function(){return this._fields[c]}})},p=function(b,c,d){var f;return b.Constructor.prototype[c]=function(){return arguments.length>0?null===arguments[0]?this[c].remove.call(this,arguments[0]):"has_many"===d.type?this[c].add.apply(this,a.flatten(arguments)):this[c].set.call(this,arguments[0]):this[c].get.call(this)},"has_many"===d.type?a(b.Constructor.prototype[c]).extend({get:function(){var a,b,e;if(!(c in this._relationships)){this._relationships[c]=[],e=i._instances[d.to.type];for(a in e)b=e[a],b[d.to.property]()===this[d.property]()&&this._relationships[c].push(b)}return this._relationships[c]},add:function(){var b,f,h,i;f=1<=arguments.length?g.call(arguments,0):[],c in this._relationships?this[c].get.call(this):this._relationships[c]=[];for(h=0,i=f.length;i>h;h++)b=f[h],a(this._relationships[c]).find(a.bind(e.EntityComparator,null,b))||(this._relationships[c].push(b),d.back&&b[d.back](this));return this.trigger("modified",[c,arguments]),this},remove:function(b){return this._relationships[c]=a(this._relationships[c]).reject(function(a){return b._compare(a)}),this}}):a(b.Constructor.prototype[c]).extend({set:a.lock(function(a){return this._relationships[c]=a,f.call(this,a),"is_a"!==d.type&&d.back&&null!=a&&a[d.back](this),this.trigger("modified",[c,a]),this}),remove:a.lock(function(){var a;return"is_a"!==d.type&&d.back&&null!=(a=this._relationships[c])&&a[d.back].remove.call(this._relationships[c],this),this._relationships[c]=null,this[d.property](void 0),this}),get:function(){var a;return void 0===this._relationships[c]&&(this._relationships[c]=i._instances[d.to.type][this[d.property]()],void 0===this._relationships[c]&&(a={},a[d.to.property]=this[d.property](),this[c](i.build(d.to.type,a)))),this._relationships[c]}}),f=function(c){var e;return void 0===c?this[d.property](void 0):b.key===d.property?c[d.to.property](this[d.property]()):c._definition().key===d.to.property?this[d.property](c[d.to.property]()):this[d.property]().match(a.UUID.rvalid)?c[d.to.property](this[d.property]()):c[d.to.property]().match(a.UUID.rvalid)?this[d.property](c[d.to.property]()):(e=a.UUID.v4(),this[d.property](e),c[d.to.property](e))}},m=function(b,c,d){var e,f,g;return d={definitions:d.definitions||{},order:d.order||[]},e=d.definitions.javascript||"",g=d.order,e&&!e.match(/window/)?(g.push(e),f=Function.apply(null,g)):f=a.noop,b.Constructor.prototype[c]=f},this.load=function(b,d){return c(b).then(function(b){return b=b||"{}",b=a.isString(b)?JSON.parse(b):b,r(b,d),j.resolve()})["catch"](function(a){return j.reject(a)}).done()},f&&f.debug&&(r(f.debug.context,h),j.resolve()),b&&this.load(b,h),this)},f=function(a){var b;return b=a._type(),this[b]||(this[b]=[]),this[b].push(a)},a(e.Runtime.prototype).extend(e.Runtime.prototype),a(e.Runtime.prototype).extend({clear:function(){return this._instances={},this},definition:function(a){return a=("function"==typeof a._type?a._type():void 0)||a,this._context.entities[a]},extend:function(b,c){return this._context.entities[b]&&a(this._context.entities[b].Constructor.prototype).extend(c.prototype),this},intern:function(b,c){var d,e,f;return c=!!c||this.settings.updateOnIntern,b.length&&!b._type?e=function(){var a,e,f;for(f=[],a=0,e=b.length;e>a;a++)d=b[a],f.push(this.intern(d,c));return f}.call(this):(c?(f=this._instances[b._type()][b.id()]||b,a(f._fields).extend(b._fields)):f=this._instances[b._type()][b.id()]||b,this._instances[b._type()][b.id()]=f,f)},build:function(b,c){var d,e,f,g;if(d=this.definition(b),!d)throw"JEFRi::Runtime::build '"+b+"' is not a defined type in this context.";return c=c||{},g=new d.Constructor(c),d.key in c&&(e={_type:b},e[d.key]=c[d.key],f=this.find(e),f.length>0)?(f=f[0],a(f._fields).extend(g._fields),f):(this._instances[b][g.id()]=g,g)},expand:function(a,b){var c,d,e,f,g,h;for(b=b||"persisted",c=[],h=a.entities||[],f=0,g=h.length;g>f;f++)e=h[f],d=this.build(e._type,e),d=this.intern(d,!0),d.trigger(b,!0),c.push(d);return a.entities=c},destroy:function(a){return delete this._instances[a._type()][a.id()],this},find:function(a){var b,c,d,e,f;if("string"==typeof a&&(a={_type:a}),f=[],c=this.definition(a._type),e=this._instances[a._type],a.hasOwnProperty(c.key||a.hasOwnProperty("_id")))e[a[c.key]]&&f.push(e[a[c.key]]);else for(b in e)d=e[b],f.push(d);return f}}),e.Transaction=function(b,c){return a(this).extend({attributes:{},store:c,entities:b instanceof Array?b:b?[b]:[]})},a(e.Transaction.prototype).extend({encode:function(){var b,c,d,e,f;for(c={attributes:this.attributes,entities:[]},f=this.entities,d=0,e=f.length;e>d;d++)b=f[d],c.entities.push(a.isEntity(b)?b._encode():b);return c},toString:function(){return JSON.stringify(this.encode())},get:function(b){var c;return c=new a.Deferred,this.trigger("getting",{}),b=b||this.store,b.execute("get",this.then(!1).promise())},persist:function(b){var c;return c=a.Deferred(),b=b||this.store,this.trigger("persisting",{}),this.trigger("persisted",function(){}),b.execute("persist",this.then(!1).promise())},add:function(b,c){var d,f,g;for(null==c&&(c=!1),b=a.isArray(b)?b:[].slice.call(arguments,0),f=0,g=b.length;g>f;f++)d=b[f],(c||a(this.entities).indexBy(e.EntityComparator(d))<0)&&this.entities.push(d);return this},attributes:function(b){return a(this.attributes).extend(b),this}}),this.JEFRi=e}.call(this,this._,this.q,Request);