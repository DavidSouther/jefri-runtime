var Request;Request=function(){var a,b;return a=function(a){var b,c,d;return c=Q.defer(),b=window.ActiveXObject||XMLHttpRequest,d=new b("Microsoft.XMLHTTP"),d.open(a.type||(a.data?"POST":"GET"),a.uri,!0),"function"==typeof d.overrideMimeType&&d.overrideMimeType(a.dataType||"text/plain"),d.onreadystatechange=function(){var b;return 4===d.readyState?(0===d.status||200===d.status?(b=d.responseText,"application/json"===a.dataType&&(b=JSON.parse(b)),c.resolve(b)):c.reject(new Error("Could not load "+a.uri)),void 0):c.notify(d)},a.data&&d.setRequestHeader("Content-type",a.dataType||"application/x-www-form-urlencoded"),d.send(a.data||null),c.promise},b=function(a,c){return c?b.post(a,{data:c}):b.get(a)},b.get=function(b,c){return c=c||{},c.uri=b,c.type="GET",c.data=null,a(c)},b.post=function(b,c){return c=c||{},c.uri=b,c.type="POST",a(c)},b}(),function(a,b,c){var d;d=function(){},d.prototype={on:function(a,b){var c;return void 0===this._listeners&&(this._listeners={}),c=this._listeners,void 0===c[a]&&(c[a]=[]),-1===c[a].indexOf(b)?c[a].push(b):void 0},off:function(a,b){var c,d;if(void 0!==this._listeners)return d=this._listeners,c=d[a].indexOf(b),-1!==c?d[a].splice(c,1):void 0},trigger:function(a){var b,c,d,e,f,g;if(void 0!==this._listeners&&(d=this._listeners,c=d[a.event],void 0!==c)){for(a.target=this,g=[],e=0,f=c.length;f>e;e++)b=c[e],g.push(b.call(this,a));return g}}};var e,f,g,h=[].slice;f={EntityComparator:function(a,b){var c;return c=a&&b&&a._type()===b._type()&&a.id()===b.id()},isEntity:function(b){return b._type&&b.id&&a.isFunction(b._type)&&a.isFunction(b.id)}},e=function(a,b,c){this.entity=a,this.field=b,this.relationship=c},e.prototype=Object.create(Array.prototype),e.prototype.remove=function(a){var b,c;if(null!==a){for(c=this.length-1;c>-1;){if(this[c]._compare(a)){if(this.relationship.back){b=this[c];try{b[this.relationship.back].remove(this)}catch(d){b[this.relationship.back]=null}}this.splice(c,1)}c--}return this}},e.prototype.add=function(b){return a(this.entity._relationships[this.field]).find(a.bind(f.EntityComparator,null,b))||(this.entity._relationships[this.field].push(b),this.relationship.back&&(b[this.relationship.back]=this.entity)),this.entity},a.mixin({isEntity:f.isEntity}),f.Runtime=function(b,g,i){var j,k,l,m,n,o,p,q,r,s,t=this;return!this instanceof f.Runtime?new f.Rutime(b,g,i):(j=this,a.isString(b)||(i=g,g=b,b=""),k=Q.defer(),l={updateOnIntern:!0},a(l).extend(g),a(this).extend({settings:l,ready:k.promise,_context:{meta:{},contexts:{},entities:{},attributes:{}},_instances:{}}),r=function(a){switch(a){case"boolean":return!1;case"int":return 0;case"string":return"";default:return""}},s=function(b){var c,d,e,f;a(t._context.attributes).extend(b.attributes||{}),e=b.entities,f=[];for(d in e)c=e[d],f.push(m(c,d));return f},m=function(b,c){return t._context.entities[c]=b,t._instances[c]={},b.Constructor=function(c){var d,e,f,g;a(this).extend({_new:!0,_modified:{_count:0},_fields:{},_relationships:{},_runtime:j}),c=c||{},c[b.key]=c[b.key]||a.UUID.v4(),g=b.properties;for(e in g)f=g[e],d=c[e]||r(f.type),this[e]=d;return this._id=this.id(!0),a(this.prototype).extend(c.prototype),this.on("persisted",function(){return a(this).extend({_new:!1,_modified:{_count:0}})}),this},p(c,b,i&&i[c])},p=function(b,c,e){var g,h,i,k,l,m,p,r,s;a(c.Constructor.prototype).extend(d.prototype,{_type:function(a){return a=a||!1,b},id:function(a){return""+(a?""+this._type()+"/":"")+this[c.key]},_status:function(){var b;return b="MODIFIED",this._new?b="NEW":a.isEmpty(this._modified)&&(b="PERSISTED"),b},_definition:function(){return c},_persist:function(b,c){var d,e;return d=a.Deferred().then(c),e=!b,b=e?new f.Transaction:b,b.add(this),this.on("persisting",b),e&&b.persist(c),d.promise()},_encode:function(){var a,b;a={_type:this._type(),_id:this.id()};for(b in c.properties)a[b]=this[b]();return a},_destroy:a.lock(function(){var a,b,d;this.trigger("destroying",{}),d=c.relationships;for(a in d)b=d[a],"has_many"===b.type?this[a].remove(this):this[a]=null;return j.destroy(this),this[c.key]=0,this.trigger("destroyed",{})}),_compare:function(a){return f.EntityComparator(this,a)}}),c.Constructor.prototype.toJSON=c.Constructor.prototype._encode,p=c.properties;for(g in p)k=p[g],o(c,g,k);r=c.relationships;for(l in r)m=r[l],q(c,l,m);s=c.methods;for(i in s)h=s[i],n(c,i,h);return e?a(c.Constructor.prototype).extend(e.prototype):void 0},o=function(a,b){return Object.defineProperty(a.Constructor.prototype,b,{set:function(a){return a!==this._fields[b]?(this._fields[b]=a,this._modified[b]?this._modified[b]===a&&(delete this._modified[b],this._modified._count-=1):(this._modified[b]=this._fields[b],this._modified._count+=1),this.trigger("modified",[b,a])):void 0},get:function(){return this._fields[b]}})},q=function(b,c,d){var f,g;return f="has_many"===d.type?{get:function(){var a,b,f;if(!(c in this._relationships)){this._relationships[c]=new e(this,c,d),f=j._instances[d.to.type];for(a in f)b=f[a],b[d.to.property]===this[d.property]&&this._relationships[c].add(b)}return this._relationships[c]},set:function(){var b,d,e,f;for(d=1<=arguments.length?h.call(arguments,0):[],d=a(d).flatten(),this[c],e=0,f=d.length;f>e;e++)b=d[e],this._relationships[c].add(b);return this.trigger("modified",[c,arguments]),this}}:{set:a.lock(function(a){var b,e;if(null===a){if("is_a"!==d.type)try{null!=(b=this._relationships[c])&&b[d.back].remove(this)}catch(f){null!=(e=this._relationships[c])&&(e[d.back]=null)}this._relationships[c]=null,this[d.property]=void 0}else this._relationships[c]=a,g.call(this,a),"is_a"!==d.type&&d.back&&null!=a&&(a[d.back]=this),this.trigger("modified",[c,a]);return this}),get:function(){var a;return void 0===this._relationships[c]&&(this._relationships[c]=j._instances[d.to.type][this[d.property]],void 0===this._relationships[c]&&(a={},a[d.to.property]=this[d.property],this[c]=j.build(d.to.type,a))),this._relationships[c]}},Object.defineProperty(b.Constructor.prototype,c,f),g=function(c){var e;return void 0===c?this[d.property]=void 0:b.key===d.property?c[d.to.property]=this[d.property]:c._definition().key===d.to.property?this[d.property]=c[d.to.property]:this[d.property].match(a.UUID.rvalid)?c[d.to.property]=this[d.property]:c[d.to.property].match(a.UUID.rvalid)?this[d.property]=c[d.to.property]:(e=a.UUID.v4(),this[d.property]=e,c[d.to.property]=e)}},n=function(b,c,d){var e,f,g;return d={definitions:d.definitions||{},order:d.order||[]},e=d.definitions.javascript||"",g=d.order,e&&!e.match(/window/)?(g.push(e),f=Function.apply(null,g)):f=a.noop,b.Constructor.prototype[c]=f},this.load=function(b,d){return c(b).then(function(b){return b=b||"{}",b=a.isString(b)?JSON.parse(b):b,s(b,d),k.resolve()})["catch"](function(a){return k.reject(a)}).done()},g&&g.debug&&(s(g.debug.context,i),k.resolve()),b&&this.load(b,i),this)},g=function(a){var b;return b=a._type(),this[b]||(this[b]=[]),this[b].push(a)},a(f.Runtime.prototype).extend(f.Runtime.prototype),a(f.Runtime.prototype).extend({clear:function(){return this._instances={},this},definition:function(a){return a=("function"==typeof a._type?a._type():void 0)||a,this._context.entities[a]},extend:function(b,c){return this._context.entities[b]&&a(this._context.entities[b].Constructor.prototype).extend(c.prototype),this},intern:function(b,c){var d,e,f;return null==c&&(c=!1),c=c||this.settings.updateOnIntern,b.length&&!b._type?e=function(){var a,e,f;for(f=[],a=0,e=b.length;e>a;a++)d=b[a],f.push(this.intern(d,c));return f}.call(this):(c?(f=this._instances[b._type()][b.id()]||b,a(f._fields).extend(b._fields)):f=this._instances[b._type()][b.id()]||b,this._instances[b._type()][b.id()]=f,f)},build:function(b,c){var d,e,f,g;if(d=this.definition(b),!d)throw"JEFRi::Runtime::build '"+b+"' is not a defined type in this context.";return c=c||{},g=new d.Constructor(c),d.key in c&&(e={_type:b},e[d.key]=c[d.key],f=this.find(e),f.length>0)?(f=f[0],a(f._fields).extend(g._fields),f):(this._instances[b][g.id()]=g,g)},expand:function(a,b){var c,d,e,f,g,h;for(b=b||"persisted",c=[],h=a.entities||[],f=0,g=h.length;g>f;f++)e=h[f],d=this.build(e._type,e),d=this.intern(d,!0),d.trigger(b,!0),c.push(d);return a.entities=c},destroy:function(a){return delete this._instances[a._type()][a.id()],this},find:function(a){var b,c,d,e,f;if("string"==typeof a&&(a={_type:a}),f=[],c=this.definition(a._type),e=this._instances[a._type],a.hasOwnProperty(c.key||a.hasOwnProperty("_id")))e[a[c.key]]&&f.push(e[a[c.key]]);else for(b in e)d=e[b],f.push(d);return f}}),f.Transaction=function(b,c){return a(this).extend({attributes:{},store:c,entities:b instanceof Array?b:b?[b]:[]})},a(f.Transaction.prototype).extend({encode:function(){var b,c,d,e,f;for(c={attributes:this.attributes,entities:[]},f=this.entities,d=0,e=f.length;e>d;d++)b=f[d],c.entities.push(a.isEntity(b)?b._encode():b);return c},toString:function(){return JSON.stringify(this.encode())},get:function(b){var c;return c=new a.Deferred,this.trigger("getting",{}),b=b||this.store,b.execute("get",this.then(!1).promise())},persist:function(b){var c;return c=a.Deferred(),b=b||this.store,this.trigger("persisting",{}),this.trigger("persisted",function(){}),b.execute("persist",this.then(!1).promise())},add:function(b,c){var d,e,g;for(null==c&&(c=!1),b=a.isArray(b)?b:[].slice.call(arguments,0),e=0,g=b.length;g>e;e++)d=b[e],(c||a(this.entities).indexBy(f.EntityComparator(d))<0)&&this.entities.push(d);return this},attributes:function(b){return a(this.attributes).extend(b),this}}),this.JEFRi=f}.call(this,this._,this.q,Request);